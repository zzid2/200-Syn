name: 更新_Luci插件                                    ## Actions工作流的名称
on:
  repository_dispatch:                                 ## 存储库调度
  workflow_dispatch:                                   ## 工作流程_调度
    inputs:
      ssh:                         ## 做判断时用的ID名称（可更改）  
        description: 'SSH远程'     ## 工作流_菜单提示框的名称
        required: false
        default: 'true-false'      ## 输入：true=开启 false=关闭
      packages:                                        ## 做判断时用的ID名称（可更改）  
        description: '更新插件'                        ## 工作流_菜单提示框的名称
        required: false
        default: 'false'
        
        
  schedule:                                            ## 定时触发开始编译(时间设置请看定时编译说明)
    - cron: 0 */6 * * *                                ## 每隔6个小时运行一次
    
    
  push:                            ## 修改任意代码（或指定文件） 触发编译
    paths:                         ## 当指定文件“修改变动时” 触发编译
      - '.github/workflows/openwrt-packages.yml'       ## 默认是"openwrt-packages.yml"文件变动时 触发编译
      - 'main.sh'                                      ## 默认是"openwrt-packages.yml"文件变动时 触发编译
      
      
env:
  Run_number: ${{github.run_number}}                   ## 当前运行工作流编号，如#12
  CangKu_URL: 'https://github.com/zzid2/luci-200.git'  ## 定时克隆并上传的仓库（换仓库_需要修改!!!）luci-app.git   luci-120.git
  REPO_BRANCH: main                                    ## 定时克隆并上传的分支（换仓库_需要修改!!!）
  TZ: Asia/Shanghai                                    ## 时区设置为上海
  
  
jobs:
  build-luci-app:                         ## 此脚本的任务名称（可自定义）
    runs-on: ubuntu-latest                ## 使用ubuntu-最新版
    if: github.event.repository.owner.id == github.event.sender.id || ! github.event.sender.id     ## 只有仓库所有者才能使用  “点 Star启动编译”


    name: 更新openwrt-packages            ## 运行工作流的名称 Update openwrt-packages
    strategy:
      fail-fast: false
      matrix:
        target: [main]                    ## 运行main分支
        
    steps:
    
    - name: 准备环境                      ## Checkout 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 安装编译环境                  ## Initialization environment
      run : |
        pwd && ls
        
        
        AUTHOR_ID=$(echo $CangKu_URL | awk -F'/' '{print $(NF-1)}')                 ## 仓库作者ID，如：zzid2
        echo "AUTHOR_ID=$AUTHOR_ID" >> $GITHUB_ENV                                  ## 仓库作者ID，写入到变量中
        CangKu_ID=$(echo $CangKu_URL | awk -F'/' '{print $NF}' | sed 's/.git//')    ## 仓库项目ID，如：120
        echo "CangKu_ID=$CangKu_ID" >> $GITHUB_ENV                                  ## 仓库项目ID，写入到变量中
        CangKu=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f2)                       ## 当前仓库的名称
        echo "CangKu=${CangKu}" >> $GITHUB_ENV                                      ## 当前仓库的名称 写入到变量中
        echo "date1=$(date "+%Y年%m月%d号-%H点%M分")" >> $GITHUB_ENV               ## = date1 变量时间格式: 2021年01月02号-13点10分
        echo "$(date +%s)" > start_time.txt                                         ## 启动时间 写入到“start_time.txt”文本中（与结尾“end_time.txt”文本对应）
        
        ## 终端添加中文
        sudo apt-get install -y language-pack-zh-hans                                    # 安装中文语言包
        echo "LANG=zh_CN.UTF-8" >> $GITHUB_ENV                                           # 加入中文语言包 的变量，会持续显示中文语言；
        
        
        git config --global user.name "actions-user"                                ## 提交名称
        git config --global user.email "$AUTHOR_ID@users.noreply.github.com"        ## 提交Github仓库的电子邮件地址（默认自己仓库）
        sudo timedatectl set-timezone "$TZ"                                         ## 设置时区为上海
        
        
        
        

        
        
        
        
        
    - name: 克隆软件包上                    ## Clone packages
      env:
        main_former: $(find main_former -mindepth 1 -maxdepth 1 -type d -exec basename {} \;)
        main_new: $(find main -mindepth 1 -maxdepth 1 -type d -exec basename {} \;)
      run: |
        pwd && ls
        
        
        git clone -b $REPO_BRANCH $CangKu_URL ${{matrix.target}}_former || {
            echo "遇到新仓库克隆失败，初始推送到新仓库！！！";
            mkdir ${{matrix.target}}_former;
            cd ${{matrix.target}}_former;
            git init .;                                                               ## 初始化一个新的Git仓库
            git config --global init.defaultBranch $REPO_BRANCH;                      ## 设置全局默认分支名称
            git branch -M $REPO_BRANCH;                                               ## 重命名当前分支为指定分支
            git checkout -b $REPO_BRANCH;                                             ## 创建并切换到指定分支
            cd ../;                                                                   ## 返回上级目录
        }                                                                             ## 克隆旧版本插件到 main 目录内，如果遇到新仓库克隆失败则初始化新的仓库。
        
        cd ${{matrix.target}}_former
        
        rm -rf {LICENSE,README,README.md,README_en.md}
        rm -rf ./*/{LICENSE,README,README.md,README_en.md}
        rm -rf ./*/*/{LICENSE,README,README.md,README_en.md}                      ## 删除无用说明
        git rm -r --cache * >/dev/null 2>&1 &
        echo "$(date +%s)" > start_time11.txt
        rm -f .git/index     ## 修复索引
        git reset    ## 修复索引
        cd $GITHUB_WORKSPACE
        
        chmod +x build/*.sh
        mkdir -p main
        cd main
        $GITHUB_WORKSPACE/build/${{matrix.target}}.sh                               ## 执行main.sh       重新克隆一遍 最新版的插件！！！
        rm -rf {LICENSE,README,README.md,README_en.md}
        rm -rf ./*/{LICENSE,README,README.md,README_en.md}
        rm -rf ./*/*/{LICENSE,README,README.md,README_en.md}                      ## 删除无用说明
        
        git rm -r --cache * >/dev/null 2>&1 &
        rm -rf `find ./* -maxdepth 0 -type d ! -name "build"` >/dev/null 2>&1
        $GITHUB_WORKSPACE/build/${{matrix.target}}.sh
        bash /$GITHUB_WORKSPACE/build/convert_translation.sh
        bash /$GITHUB_WORKSPACE/build/create_acl_for_luci.sh -a
        bash /$GITHUB_WORKSPACE/build/Modify.sh
        
        cd $GITHUB_WORKSPACE
        
        echo "main_former=$main_former" >> $GITHUB_ENV
        echo "main_new=$main_new" >> $GITHUB_ENV
        echo "duplicate_subdirs=$(echo "$main_former" | grep -xF -f <(echo "$main_new"))" >> $GITHUB_ENV
        
        # 删除 main_former 中的重复子目录
        for subdir in $duplicate_subdirs; do
            rm -rf "main_former/$subdir"
            echo "Removing duplicate directory: main_former/$subdir"
        done
        
        mv main_former main
        
        
    - name: SSH链接（到此预计10分钟）     ## SSH connection to Actions
      uses: P3TERX/ssh2actions@v1.0.0
      if: github.event.inputs.ssh == 'true'
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        
        
        
        
        

        
    - name: 上传   ## Upload
      env: 
        ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}          ## 项目仓库中添加：ACCESS_TOKEN 令牌值
      run: |
        pwd && ls
        
        if [ -e $GITHUB_WORKSPACE/LICENSE ]; then          ## 判断！当工作目录内有 LICENSE 文件时，复制到  工作目录/main目录内
          cp $GITHUB_WORKSPACE/LICENSE $GITHUB_WORKSPACE/${{matrix.target}}
        fi
        
        if [ -e $GITHUB_WORKSPACE/README.md ]; then        ## 判断！ 当有 README.md 文件时，复制到main目录内
          cp $GITHUB_WORKSPACE/README.md $GITHUB_WORKSPACE/${{matrix.target}}
        fi
        
        cd $GITHUB_WORKSPACE/${{matrix.target}}            ## 进入到main目录内
        git add .
        git commit -am "更新时间：$(date '+%Y-%m-%d %H:%M:%S')"     ## 插件后面备注更新时间
        git push --quiet "https://${{ secrets.ACCESS_TOKEN }}@github.com/$AUTHOR_ID/$CangKu_ID.git" HEAD:${{matrix.target}}
                
    - name: 上传bin目录(全部固件+ipk)               ## Upload bin directory
      uses: actions/upload-artifact@v4              ## https://github.com/actions/upload-artifact
      with:
        name: Bin_${{ env.NAME2 }}${{ env.NAME1 }}_${{ env.date }}     # 文件名称
        path: |                # bin目录路径
          ${{ github.workspace }}
          ./main
        
    - name: 删除工作流程运行      ## Delete workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ secrets.ACCESS_TOKEN }}
        repository: ${{ github.repository }}
        retain_days: 1
        keep_minimum_runs: 2

        
    - name: 计算总运行时长
      run : |
        # 计算运行时长必要的依赖工具（bc awk）
        
        echo "$(date +%s)" > end_time.txt                   ## 结束时间 写入到“end_time.txt”文本中（与开头“start_time.txt”文本对应）
        ELAPSED_MINUTES=$(awk -v start=$(cat start_time.txt) -v end=$(cat end_time.txt) 'BEGIN { elapsed = end - start; printf "%.2f", elapsed / 60 }')         ## = ELAPSED_MINUTES变量：计算运行时间，并保留两位小数点和保留前面有0
        echo "ELAPSED_MINUTES=$ELAPSED_MINUTES" >> $GITHUB_ENV                                                                                                  ## 总运行时间（分钟）写入变量： ELAPSED_MINUTES    ELAPSED_TIME
        rm -rf {start_time.txt,end_time.txt}
        
        
    - name: 准备编译_pushplus微信通知       ## Github设置里需添微信SCKEY=PUSHPLUS值
      uses: xhnmt/pushplus-action@v1.0.0
      with:
        token: ${{ secrets.SCKEY }}
        title: "更新插件_${{env.CangKu}}_#${{env.Run_number}}"
        content: "
              
              仓库名称：${{env.CangKu}}
              
              
              工作流号：#${{env.Run_number}}
              
              
              启动时间：${{ env.date1 }}
              
              
              运行时间：全程用时 ${{ env.ELAPSED_MINUTES }} 分钟
              
              
              "
              ## 结尾
              
